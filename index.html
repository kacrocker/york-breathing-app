<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMST 150 Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald 500
                        'secondary': '#059669', // Emerald 600
                        'dark-bg': '#1f2937', // Gray 800
                        'light-text': '#f9fafb', // Gray 50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Custom pulse for the timer circle */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.3);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .timer-ring-active {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Confetti Animation */
        @keyframes confetti-fall {
            0% { 
                transform: translateY(-100vh) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(720deg); 
                opacity: 0; 
            }
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0;
            animation: confetti-fall linear infinite;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-dark-bg font-sans text-light-text h-screen flex items-center justify-center p-4 overflow-hidden">
    
    <!-- Confetti Container (Fixed and hidden by default) -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <div id="app" class="w-full max-w-lg bg-gray-700 p-6 sm:p-8 rounded-xl shadow-2xl transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-primary mb-2">York Breathing Exercise Timer</h1>
        <p class="text-center text-sm text-gray-400 mb-6">for use with an EMST 75/150 Trainer</p>
        
        <!-- Rest Duration Selector -->
        <div class="mb-6 p-4 bg-gray-800 rounded-lg text-sm text-gray-300 border-l-4 border-gray-600">
            <label class="block text-md font-semibold text-gray-100 mb-2">Select Rest Phase Duration:</label>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-6">
                <label class="flex items-center space-x-2 cursor-pointer transition-colors duration-150 hover:text-primary">
                    <input type="radio" name="rest-duration" value="15" checked 
                           class="form-radio appearance-none h-4 w-4 border border-gray-400 rounded-full bg-gray-600 checked:bg-primary checked:border-primary focus:outline-none focus:ring-2 focus:ring-primary" 
                           onchange="handleRestDurationChange(this.value)">
                    <span>15 seconds</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer transition-colors duration-150 hover:text-primary">
                    <input type="radio" name="rest-duration" value="30" 
                           class="form-radio appearance-none h-4 w-4 border border-gray-400 rounded-full bg-gray-600 checked:bg-primary checked:border-primary focus:outline-none focus:ring-2 focus:ring-primary" 
                           onchange="handleRestDurationChange(this.value)">
                    <span>30 seconds</span>
                </label>
            </div>
        </div>

        <!-- Status Display (Handles all messages and instructions) -->
        <div class="text-center mb-8">
            <div id="status-text" class="text-3xl font-extrabold mb-2 h-14 text-white flex items-center justify-center transition-colors duration-300">Ready</div>
        </div>

        <!-- Timer & Controls Wrapper (New Responsive Block) -->
        <div class="flex flex-col sm:flex-row sm:justify-around sm:items-center mb-10">

            <!-- Timer Display (The big circle) - Left side on desktop, top on mobile -->
            <div id="timer-display-container" class="relative flex items-center justify-center h-48 w-48 sm:h-56 sm:w-56 mx-auto sm:mx-0">
                <!-- Pulse Ring (only visible when active) -->
                <div id="pulse-ring" class="absolute h-full w-full rounded-full bg-primary opacity-30 hidden"></div>
                
                <!-- Main Timer Circle -->
                <div class="relative flex flex-col items-center justify-center h-full w-full rounded-full bg-gray-800 border-4 border-gray-600 shadow-inner-xl transition-all duration-300">
                    <span id="timer-value" class="text-6xl sm:text-7xl font-mono font-bold text-primary transition-colors duration-300">0</span>
                    <span class="text-sm font-medium text-gray-400 mt-2">seconds</span>
                </div>
            </div>

            <!-- Controls (Now stacked vertically on the right) -->
            <div class="mt-8 sm:mt-0 flex flex-col justify-center space-y-4 w-full sm:w-1/3 sm:min-w-max">
                <button id="start-button" 
                        class="px-6 py-3 text-lg font-semibold rounded-lg bg-primary hover:bg-secondary text-light-text transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 w-full">
                    Start Session
                </button>
                
                <!-- Dynamic Active/Paused Controls -->
                <div id="active-controls" class="flex flex-col space-y-4 hidden">
                    <button id="pause-resume-button" 
                            class="px-6 py-3 text-lg font-semibold rounded-lg bg-red-600 hover:bg-red-700 text-light-text transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-red-600 focus:ring-opacity-50 w-full">
                        Pause Session
                    </button>
                     <button id="reset-button" 
                            class="px-6 py-3 text-lg font-semibold rounded-lg bg-gray-500 hover:bg-gray-600 text-light-text transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 w-full">
                        Reset Session
                    </button>
                </div>
            </div>
        </div>

        <!-- Set Progress Status Boxes -->
        <div class="mt-8 pt-4 border-t border-gray-600">
            <h3 class="text-lg font-semibold text-gray-300 mb-4 text-center">Set Progress (Reps Completed)</h3>
            <div id="set-progress-container" class="grid grid-cols-5 gap-3">
                
                <!-- Set Box 1 -->
                <div id="set-box-1" class="set-box relative p-2 rounded-lg text-center bg-gray-500 transition-colors duration-300 shadow-xl">
                    <div class="text-xs font-medium text-light-text opacity-70">Set 1</div>
                    <div class="set-rep-counter text-xl font-bold text-light-text">0</div>
                    <!-- Checkmark -->
                    <div class="checkmark-container hidden absolute top-1 right-1">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Set Box 2 -->
                <div id="set-box-2" class="set-box relative p-2 rounded-lg text-center bg-gray-500 transition-colors duration-300 shadow-xl">
                    <div class="text-xs font-medium text-light-text opacity-70">Set 2</div>
                    <div class="set-rep-counter text-xl font-bold text-light-text">0</div>
                    <!-- Checkmark -->
                    <div class="checkmark-container hidden absolute top-1 right-1">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Set Box 3 -->
                <div id="set-box-3" class="set-box relative p-2 rounded-lg text-center bg-gray-500 transition-colors duration-300 shadow-xl">
                    <div class="text-xs font-medium text-light-text opacity-70">Set 3</div>
                    <div class="set-rep-counter text-xl font-bold text-light-text">0</div>
                    <!-- Checkmark -->
                    <div class="checkmark-container hidden absolute top-1 right-1">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>

                <!-- Set Box 4 -->
                <div id="set-box-4" class="set-box relative p-2 rounded-lg text-center bg-gray-500 transition-colors duration-300 shadow-xl">
                    <div class="text-xs font-medium text-light-text opacity-70">Set 4</div>
                    <div class="set-rep-counter text-xl font-bold text-light-text">0</div>
                    <!-- Checkmark -->
                    <div class="checkmark-container hidden absolute top-1 right-1">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>

                <!-- Set Box 5 -->
                <div id="set-box-5" class="set-box relative p-2 rounded-lg text-center bg-gray-500 transition-colors duration-300 shadow-xl">
                    <div class="text-xs font-medium text-light-text opacity-70">Set 5</div>
                    <div class="set-rep-counter text-xl font-bold text-light-text">0</div>
                    <!-- Checkmark -->
                    <div class="checkmark-container hidden absolute top-1 right-1">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Total Time Remaining Display -->
        <div class="mt-4 text-center text-sm font-medium text-gray-400">
            <span id="total-time-label">Time Remaining:</span>
            <span id="total-time-value" class="ml-2 text-white font-bold">00:00</span>
        </div>
        
    </div>

    <!-- Confirmation Modal HTML -->
    <div id="reset-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-75 transition-opacity duration-300" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="bg-gray-700 rounded-xl p-6 w-11/12 max-w-sm shadow-2xl transform transition-all">
            <div class="flex flex-col items-center">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100">
                    <!-- Icon for confirmation - using simple SVG cross -->
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-light-text" id="modal-title">Reset Session?</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-300">
                            Are you sure you want to **Reset** this exercise session? All progress will be lost.
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button type="button" id="confirm-reset" 
                        class="inline-flex w-full justify-center rounded-lg border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-light-text shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 sm:col-start-2 sm:text-sm transition-colors duration-200">
                    Yes, Reset
                </button>
                <button type="button" id="cancel-reset"
                        class="mt-3 inline-flex w-full justify-center rounded-lg border border-gray-600 bg-gray-600 px-4 py-2 text-base font-medium text-light-text shadow-sm hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:col-start-1 sm:mt-0 sm:text-sm transition-colors duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase (required by the environment, but not used for this simple local timer app)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Timer State and Constants ---
        const TIMER_STATE = {
            IDLE: 'IDLE',
            PAUSED: 'PAUSED',
            ACTIVE_REP: 'ACTIVE_REP', // Full 15s or 30s cycle countdown
            LONG_BREAK: 'LONG_BREAK', // 60s break
        };
        
        // Sub-phase definitions for internal tick logic and status updates
        const SUB_PHASE = {
            INHALE: 'Inhale Deeply',
            EXHALE: 'Exhale Forcefully',
            REST: 'Rest & Recover',
        };
        
        // Constants for Total Session Time calculation
        const TOTAL_REPS = 25; // 5 Sets * 5 Reps
        const NUM_LONG_BREAKS = 4; // Breaks after Sets 1, 2, 3, 4
        const LONG_BREAK_DURATION_MS = 60000; // 1 minute

        // Instructional messages
        const INITIAL_INSTRUCTIONS = "Press 'Start Session' to begin. Focus on Inhaling Deeply and Exhaling Forcefully against the device's resistance.";
        const EXHALE_INSTRUCTIONS = 'Exhale Forcefully (< 2 seconds)'; 
        const PAUSE_INSTRUCTIONS = "Session Paused. Click 'Resume Session' to Continue.";


        // Durations are now only for the full active rep and the long break
        const PHASE_DURATIONS_MS = {
            [TIMER_STATE.ACTIVE_REP]: 15000,  // Default: 15 seconds total (1s Inhale + 2s Exhale + 12s Rest)
            [TIMER_STATE.LONG_BREAK]: 60000 // 60 seconds (1 minute)
        };
        // Internal variables to track dynamic settings
        let currentRepDurationMs = 15000;
        let currentRestLabel = 'Rest & Recover'; // Simplified label
        let totalSessionDurationMs = 0; // Calculated on start/duration change


        const PHASE_COLOR_CLASS = {
            [SUB_PHASE.INHALE]: 'text-cyan-400',
            [SUB_PHASE.EXHALE]: 'text-red-500',
            [SUB_PHASE.REST]: 'text-green-400',
            [TIMER_STATE.LONG_BREAK]: 'text-yellow-400',
            [TIMER_STATE.PAUSED]: 'text-yellow-500',
            [TIMER_STATE.IDLE]: 'text-white'
        };
        
        const CONFETTI_COLORS = ['#f9fafb', '#10b981', '#f59e0b', '#ef4444', '#3b82f6']; // White, Emerald, Amber, Red, Blue

        let currentState = TIMER_STATE.IDLE;
        let animationFrameId = null;
        let repCount = 0; // Total reps completed since session start (Max 25)
        let phaseStartTime = 0;
        let sessionStartTime = 0; // Tracks the start of the entire session
        let timeRemainingWhenPaused = 0;
        let setProgress = [0, 0, 0, 0, 0]; 
        // activeStateBeforePause will hold ACTIVE_REP or LONG_BREAK
        let activeStateBeforePause = TIMER_STATE.ACTIVE_REP; 
        let wasRunningBeforeModal = false;


        // DOM Elements
        const startButton = document.getElementById('start-button');
        const activeControls = document.getElementById('active-controls');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const resetButton = document.getElementById('reset-button');
        const statusText = document.getElementById('status-text');
        const timerValue = document.getElementById('timer-value');
        const pulseRing = document.getElementById('pulse-ring');
        const timerContainer = document.getElementById('timer-display-container').querySelector('.relative.flex.flex-col');
        const setBoxes = document.querySelectorAll('.set-box');
        const totalTimeValue = document.getElementById('total-time-value');
        const confettiContainer = document.getElementById('confetti-container');


        // MODAL ELEMENTS
        const resetModal = document.getElementById('reset-modal');
        const confirmResetButton = document.getElementById('confirm-reset');
        const cancelResetButton = document.getElementById('cancel-reset');
        
        let audioContext;
        
        // --- Helper Functions ---
        
        /** Formats milliseconds into M:SS string. */
        const formatTime = (ms) => {
            if (ms <= 0) return '00:00';
            
            const totalSeconds = Math.ceil(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            const pad = (num) => num.toString().padStart(2, '0');
            
            return `${pad(minutes)}:${pad(seconds)}`;
        };

        /** Calculates the total session duration based on current rep duration setting. */
        const calculateTotalDuration = (repDurationMs) => {
            // Total Duration = (25 Reps * Rep Duration) + (4 Breaks * 1 Min)
            // Note: The last set does not have a break.
            totalSessionDurationMs = (TOTAL_REPS * repDurationMs) + (NUM_LONG_BREAKS * LONG_BREAK_DURATION_MS);
        };
        
        /** Generates and animates a burst of confetti. */
        const showCelebration = () => {
            // Clear existing confetti
            confettiContainer.innerHTML = '';
            
            // Generate 50 particles
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                
                // Random position, color, size, and delay
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
                confetti.style.width = `${Math.random() * 5 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.animationDuration = `${Math.random() * 3 + 4}s`; // 4s to 7s duration
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.opacity = 1;
                
                confettiContainer.appendChild(confetti);
            }
            
            // Hide and clear confetti after the animation duration (e.g., 7 seconds max)
            setTimeout(() => {
                confettiContainer.innerHTML = '';
            }, 7000);
        };


        /** Sets the content and adjusts the font size of the main status display. */
        const setStatusText = (text, phase) => {
            statusText.innerHTML = text;
            
            // Determine color class: use phase color if available, otherwise default to white
            const colorClass = PHASE_COLOR_CLASS[phase] || PHASE_COLOR_CLASS[TIMER_STATE.IDLE];
            statusText.className = `font-extrabold mb-2 h-14 flex items-center justify-center transition-colors duration-300 ${colorClass}`; 

            // Adjust font size based on content length or line breaks
            if (text.length > 30 || text.includes('<br>')) {
                // For long messages/instructions/breaks
                statusText.classList.add('text-xl', 'font-semibold'); 
                statusText.classList.remove('text-3xl'); 
            } else {
                // For short phase names (e.g., Inhale Deeply, Paused, Ready)
                statusText.classList.add('text-3xl'); 
                statusText.classList.remove('text-xl', 'font-semibold'); 
            }
        };

        // --- Modal Functions ---
        const openResetModal = () => {
            resetModal.classList.remove('hidden');
            resetModal.classList.add('flex');
        };

        const closeResetModal = () => {
            resetModal.classList.add('hidden');
            resetModal.classList.remove('flex');
        };

        // --- Duration Handler Function ---
        window.handleRestDurationChange = (value) => {
            let newDurationMs;
            let newLabel;

            if (value === '30') {
                newDurationMs = 30000; // 1s Inhale + 2s Exhale + 27s Rest = 30s
                newLabel = 'Rest & Recover'; // Simplified label
            } else {
                newDurationMs = 15000; // 1s Inhale + 2s Exhale + 12s Rest = 15s
                newLabel = 'Rest & Recover'; // Simplified label
            }

            // Check if session is running and force reset
            if (currentState !== TIMER_STATE.IDLE) {
                resetSession(false);
                setStatusText(`Duration Changed. Session Was Reset. Press 'Start Session' to Begin.`, TIMER_STATE.IDLE);
            }

            // Update internal variables and constants globally
            currentRepDurationMs = newDurationMs;
            currentRestLabel = newLabel;
            PHASE_DURATIONS_MS[TIMER_STATE.ACTIVE_REP] = currentRepDurationMs;
            
            // Recalculate total session duration
            calculateTotalDuration(currentRepDurationMs);
            // Update total time display with new total duration
            totalTimeValue.textContent = formatTime(totalSessionDurationMs);
        };
        
        /** Initializes the Web Audio API context. */
        const initAudio = () => {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error('Web Audio API not supported:', e);
                }
            }
        };


        // --- Audio Functions ---
        const playTone = (frequency, duration) => {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        };
        
        // This function now uses the subPhase state passed to it
        let lastPlayedSubPhase = null;
        const playTransitionChime = (subPhase) => {
             // Only play chime when transitioning into a new subPhase
             if (lastPlayedSubPhase === subPhase) return;
             
             if (subPhase === SUB_PHASE.INHALE || subPhase === SUB_PHASE.REST) {
                playTone(440, 0.1); // Low-pitch chime for prep/rest
             }
             if (subPhase === SUB_PHASE.EXHALE) {
                playTone(880, 0.2); // High-pitch beep for action
             }
             lastPlayedSubPhase = subPhase;
        };
        
        /** Updates the visual progress boxes (Set 1-5) based on current setProgress array. */
        const updateSetBoxes = () => {
            setProgress.forEach((reps, index) => {
                const box = setBoxes[index];
                const counterElement = box.querySelector('.set-rep-counter');
                const checkmarkElement = box.querySelector('.checkmark-container');
                
                counterElement.textContent = reps;
                box.classList.remove('bg-gray-500', 'bg-gray-900', 'bg-green-500');

                if (reps === 0) {
                    box.classList.add('bg-gray-500'); 
                    checkmarkElement.classList.add('hidden');
                } else if (reps >= 1 && reps <= 4) {
                    box.classList.add('bg-gray-900'); 
                    checkmarkElement.classList.add('hidden');
                } else if (reps === 5) {
                    box.classList.add('bg-green-500'); 
                    checkmarkElement.classList.remove('hidden');
                }
            });
        };


        // --- Timer Logic ---

        /** Updates the UI for the timer value and pulse ring. */
        const updateUI = (phase, remainingTimeS) => {
            // Update timer value (formatted to show only whole seconds)
            timerValue.textContent = Math.ceil(remainingTimeS).toString();

            // Update pulse ring and shadow
            const isCriticalPhase = (phase === SUB_PHASE.EXHALE || phase === SUB_PHASE.INHALE);
            if (isCriticalPhase) {
                pulseRing.classList.remove('hidden');
                pulseRing.classList.add('timer-ring-active');
                timerContainer.classList.add('border-primary');
                timerValue.classList.add('text-primary');
            } else {
                pulseRing.classList.add('hidden');
                pulseRing.classList.remove('timer-ring-active');
                timerContainer.classList.remove('border-primary');
                timerValue.classList.remove('text-primary');
            }
        };

        /** Stops and resets the timer session. */
        const resetSession = (isCompleted = false) => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            currentState = TIMER_STATE.IDLE;
            repCount = 0;
            timeRemainingWhenPaused = 0;
            setProgress = [0, 0, 0, 0, 0];
            lastPlayedSubPhase = null; // Reset audio tracker
            sessionStartTime = 0; // Reset session start time
            
            // UI reset
            startButton.classList.remove('hidden');
            activeControls.classList.add('hidden');

            if (isCompleted) {
                // SESSION COMPLETE message (two lines, large font)
                setStatusText('Session<br>Complete!', TIMER_STATE.IDLE);
                showCelebration(); // <-- Show confetti for celebration!
            } else {
                // Reset message or Initial Instructions
                setStatusText(INITIAL_INSTRUCTIONS, TIMER_STATE.IDLE);
            }
            
            timerValue.textContent = '0';
            pulseRing.classList.add('hidden');
            pulseRing.classList.remove('timer-ring-active');
            timerContainer.classList.remove('border-primary');
            timerValue.classList.remove('text-primary');
            
            // Update total time display to show initial duration
            totalTimeValue.textContent = formatTime(totalSessionDurationMs);

            updateSetBoxes(); // Resets set boxes visually
        };

        /** Transitions the state machine to the next major phase. */
        const nextState = () => {
            let nextPhase;

            // This only handles transitions between major phases (Rep Cycle, Long Break, End)
            switch (currentState) {
                case TIMER_STATE.ACTIVE_REP:
                    repCount++; 
                    
                    const currentSetIndex = Math.floor((repCount - 1) / 5); 
                    const currentRepInSet = (repCount % 5) || 5;
                    
                    if (currentSetIndex < 5) {
                        setProgress[currentSetIndex] = currentRepInSet; 
                        updateSetBoxes();
                    }

                    // *** MODIFIED LOGIC HERE ***
                    if (repCount >= 25) { 
                        // If the final rep (rep 25) is complete, end the session immediately.
                        resetSession(true); 
                        return;
                    } else if (repCount % 5 === 0) {
                        // If a set (1-4) is complete, go to the long break.
                        nextPhase = TIMER_STATE.LONG_BREAK;
                    } else {
                        // Normal rep cycle, repeat ACTIVE_REP (which handles the rest period internally).
                        nextPhase = TIMER_STATE.ACTIVE_REP;
                    }
                    break;
                case TIMER_STATE.LONG_BREAK:
                    // This case is only reached after Sets 1-4.
                    nextPhase = TIMER_STATE.ACTIVE_REP;
                    break;
                case TIMER_STATE.IDLE: // Start from ACTIVE_REP
                    nextPhase = TIMER_STATE.ACTIVE_REP;
                    break;
                default:
                    resetSession();
                    return;
            }

            currentState = nextPhase;
            phaseStartTime = Date.now();
            lastPlayedSubPhase = null; // Ensure audio chime plays immediately in the next phase
            
            // Set Status Text immediately for the new major phase
            if (currentState === TIMER_STATE.LONG_BREAK) {
                const completedSet = repCount / 5; 
                const breakMessage = `1 Minute Break<br><span class="text-xl font-normal">(Set ${completedSet} Complete)</span>`; 
                setStatusText(breakMessage, currentState);
            } 
            
            // Start time remaining update
            updateUI(currentState, PHASE_DURATIONS_MS[currentState] / 1000); 
        };

        /** Updates the status bar dynamically during the ACTIVE_REP phase. */
        const updateActiveRepStatus = (elapsedMs) => {
            let subPhase;
            
            if (elapsedMs < 1000) {
                subPhase = SUB_PHASE.INHALE;
            } else if (elapsedMs < 3000) { // EXHALE now runs for 2 seconds (from 1000ms to 3000ms)
                subPhase = SUB_PHASE.EXHALE;
            } else {
                subPhase = SUB_PHASE.REST;
            }
            
            playTransitionChime(subPhase);

            // Determine display text based on subPhase
            let displayText;
            if (subPhase === SUB_PHASE.EXHALE) {
                // Use detailed instruction for exhale
                displayText = EXHALE_INSTRUCTIONS;
            } else if (subPhase === SUB_PHASE.REST) {
                // Use dynamic rest label
                displayText = currentRestLabel;
            } else {
                // Use short label for inhale
                displayText = SUB_PHASE.INHALE;
            }

            setStatusText(displayText, subPhase);
        };


        /** The main animation loop (called by requestAnimationFrame). */
        const tick = () => {
            if (currentState === TIMER_STATE.IDLE || currentState === TIMER_STATE.PAUSED) return;

            const now = Date.now();
            const elapsed = now - phaseStartTime;
            
            const duration = PHASE_DURATIONS_MS[currentState];
            let remaining = duration - elapsed;
            
            if (remaining <= 0) {
                nextState();
            } else {
                const remainingSeconds = remaining / 1000;
                updateUI(currentState, remainingSeconds);

                // Handle status updates within the ACTIVE_REP state
                if (currentState === TIMER_STATE.ACTIVE_REP) {
                    updateActiveRepStatus(elapsed);
                }
            }

            // --- Total Session Time Remaining Logic ---
            const totalElapsed = now - sessionStartTime;
            let totalRemaining = totalSessionDurationMs - totalElapsed;
            
            if (totalRemaining < 0) totalRemaining = 0;
            totalTimeValue.textContent = formatTime(totalRemaining);

            animationFrameId = requestAnimationFrame(tick);
        };

        /** Starts the timer session from IDLE state. */
        const startSession = () => {
            if (currentState !== TIMER_STATE.IDLE) return;
            
            initAudio(); 
            
            // UI setup
            startButton.classList.add('hidden');
            activeControls.classList.remove('hidden');
            pauseResumeButton.textContent = 'Pause Session';
            pauseResumeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            pauseResumeButton.classList.add('bg-red-600', 'hover:bg-red-700');

            // Set session start time
            sessionStartTime = Date.now(); 
            
            // Start state machine
            nextState(); 
            
            // Start the loop
            animationFrameId = requestAnimationFrame(tick);
        };

        /** Pauses the timer. */
        const pauseTimer = () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            const elapsedSincePhaseStart = Date.now() - phaseStartTime;
            const duration = PHASE_DURATIONS_MS[currentState];
            timeRemainingWhenPaused = duration - elapsedSincePhaseStart;
            
            activeStateBeforePause = currentState; 
            currentState = TIMER_STATE.PAUSED;
            lastPlayedSubPhase = null; // Reset audio tracker

            // UI update for pause
            pauseResumeButton.textContent = 'Resume Session';
            pauseResumeButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            
            // Display pause instruction text
            setStatusText(PAUSE_INSTRUCTIONS, TIMER_STATE.PAUSED);
            
            // Display the time remaining when paused (current phase)
            updateUI(currentState, timeRemainingWhenPaused / 1000);
            
            // Update total time display for pause state
            const totalElapsed = Date.now() - sessionStartTime;
            let totalRemaining = totalSessionDurationMs - totalElapsed;
            if (totalRemaining < 0) totalRemaining = 0;
            totalTimeValue.textContent = formatTime(totalRemaining);
        };

        /** Resumes the timer. */
        const resumeTimer = () => {
            currentState = activeStateBeforePause; 

            const duration = PHASE_DURATIONS_MS[currentState];
            
            phaseStartTime = Date.now() - (duration - timeRemainingWhenPaused); 
            timeRemainingWhenPaused = 0; 

            // UI update for resume
            pauseResumeButton.textContent = 'Pause Session';
            pauseResumeButton.classList.add('bg-red-600', 'hover:bg-red-700');
            pauseResumeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            
            // Recalculate and set the status text immediately
            if (currentState === TIMER_STATE.LONG_BREAK) {
                 const completedSet = repCount / 5; 
                 const breakMessage = `1 Minute Break<br><span class="text-xl font-normal">(Set ${completedSet} Complete)</span>`; 
                 setStatusText(breakMessage, currentState);
            } else if (currentState === TIMER_STATE.ACTIVE_REP) {
                 // Calculate elapsed time since phase start to determine the sub-phase
                 const elapsed = Date.now() - phaseStartTime;
                 updateActiveRepStatus(elapsed);
            }

            // Restart the loop
            animationFrameId = requestAnimationFrame(tick);
            
            const remainingSeconds = (duration - (Date.now() - phaseStartTime)) / 1000;
            updateUI(currentState, remainingSeconds);
        };


        // --- Event Listeners and Initialization ---

        startButton.addEventListener('click', () => {
            if (currentState === TIMER_STATE.IDLE) {
                startSession();
            }
        });

        pauseResumeButton.addEventListener('click', () => {
            if (currentState === TIMER_STATE.PAUSED) {
                resumeTimer();
            } else if (currentState !== TIMER_STATE.IDLE) {
                pauseTimer();
            }
        });

        resetButton.addEventListener('click', () => {
            if (currentState !== TIMER_STATE.IDLE) {
                wasRunningBeforeModal = (currentState !== TIMER_STATE.PAUSED);

                if (wasRunningBeforeModal) {
                    pauseTimer(); 
                }
                
                openResetModal();
            }
        });

        confirmResetButton.addEventListener('click', () => {
            resetSession(false);
            closeResetModal();
            wasRunningBeforeModal = false;
        });
        
        cancelResetButton.addEventListener('click', () => {
            closeResetModal();
            if (wasRunningBeforeModal) {
                resumeTimer();
            }
            wasRunningBeforeModal = false;
        });

        // Initialization: Set the default duration and initial instructions
        window.handleRestDurationChange('15'); 
        
        // Initial setup for the UI
        setStatusText(INITIAL_INSTRUCTIONS, TIMER_STATE.IDLE);
        updateUI(TIMER_STATE.IDLE, 0);
        updateSetBoxes(); 

    </script>
</body>
</html>